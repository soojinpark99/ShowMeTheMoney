<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Show me the Money</title>
  </head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .layout {
      width: 430px;
      height: 926px;
      margin: 50px auto;
      padding: 15px;
      background-color: #fafaf9;
      position: relative;
    }

    .calendar {
      width: 400px;
      margin: 10px auto;

      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;

      margin-top: 30px;
    }

    .btn {
      cursor: pointer;
    }

    .sum-div {
      margin: 10px 0;
    }

    .sum-div > div {
      margin-bottom: 5px;
    }

    .income,
    .expense,
    .total {
      margin-left: 10px;
    }

    .income {
      color: #5fbb82;
    }

    .expense {
      color: #e16f63;
    }

    .day {
      text-align: center;
      margin-top: 10px;
    }
    .date,
    .empty {
      aspect-ratio: 1;
    }

    .date {
      cursor: pointer;
      padding: 3px;
    }

    .date:hover {
      border: 1px solid #bebfc0;
    }

    .selected-date {
      background-color: #bebfc0;
    }

    .write-btn {
      display: flex;
      justify-content: center;
      align-items: center;

      color: black;
      text-decoration: none;

      cursor: pointer;
    }

    .write-btn:hover {
      background-color: #f0f3f4;
    }

    .transaction-div {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .write-btn,
    .transaction-div {
      background-color: white;
      width: 100%;
      height: 80px;
      padding: 15px 15px;
      margin-bottom: 5px;
      border: 1.3px solid #e6e6e6;
      border-radius: 10px;
    }

    .transaction-category {
      margin-bottom: 5px;
    }

    .transaction-memo {
      color: #a0a1a6;
    }

    .transaction-money {
      font-size: 30px;
    }
  </style>
  <body>
    <div class="layout">
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="prev btn">◀</div>
          <h2 id="currentMonth"></h2>
          <div class="next btn">▶</div>
        </div>
        <div class="sum-div">
          <div>
            수입
            <span class="income">+600000</span>
          </div>
          <div>
            지출
            <span class="expense">-500000</span>
          </div>
          <div>
            합계
            <span class="total">+100000</span>
          </div>
        </div>
        <div class="calendar days">
          <div class="day">일</div>
          <div class="day">월</div>
          <div class="day">화</div>
          <div class="day">수</div>
          <div class="day">목</div>
          <div class="day">금</div>
          <div class="day">토</div>
        </div>
        <div class="calendar dates" id="calendarDates"></div>
      </div>
      <a class="write-btn" th:href="@{/write}">+ 새로운 거래 추가하기</a>
      <div class="transactions"></div>
    </div>
    <script>
      const today = new Date();
      let currentMonth = today.getMonth();
      let currentYear = today.getFullYear();
      let currentDate = today.getDate();

      const host = window.location.host;
      const pathname = window.location.pathname.split("/");
      const username = pathname[pathname.length - 1];

      // 임의로 작성한 데이터
      /*const datas = [
        {
          division: "expense",
          money: "13000",
          date: "2024-03-22",
          category: "food",
          memo: "배달의 민족",
        },
        {
          division: "expense",
          money: "1000",
          date: "2024-02-24",
          category: "food",
          memo: "편의점",
        },
        {
          division: "expense",
          money: "18000",
          date: "2024-02-23",
          category: "culture",
        },
        {
          division: "income",
          money: "10000",
          date: "2024-02-23",
          category: "additional",
          memo: "당근마켓",
        },
      ];*/

      // --- 특정 날짜에 해당하는 데이터를 렌더링하여 페이지에 추가 ---
      async function renderData() {
        // 특정 날짜에 해당하는 데이터 불러오기

        const res = await fetch(`${host}/username/${username}?date=${currentYear}-${currentMonth}-${currentDate}`);
        //const res = await fetch(`/username/${username}?date=${currentYear}-${currentMonth}-${currentDate}`);
        const filteredData = res.json();
        /*const filteredData = datas.filter((data) => {
          const dataDate = new Date(data.date);
          return (
            dataDate.getFullYear() == currentYear &&
            dataDate.getMonth() == currentMonth &&
            dataDate.getDate() == currentDate
          );
        });

         */

        // 거래 내역 동적 생성
        const transactions = document.querySelector(".transactions");
        transactions.innerHTML = "";

        filteredData.reverse().forEach((data) => {
          const transactionDiv = document.createElement("div");
          transactionDiv.classList.add("transaction-div");

          const money = document.createElement("div");
          if (data.division === "income") {
            money.textContent = "+" + data.money;
            money.classList.add("transaction-money");
            money.style.color = "#5fbb82";
          } else {
            money.textContent = -data.money;
            money.classList.add("transaction-money");
            money.style.color = "#e16f63";
          }
          const div = document.createElement("div");
          const category = document.createElement("div");
          const memo = document.createElement("div");

          const categoryList = {
            food: "식비",
            cafe: "카페",
            mart: "마트/생필품",
            culture: "문화생활",
            medical: "의료비",
            dues: "공과금",
            transportation: "교통비",
            communication: "통신비",
            subscription: "구독료",
            hobby: "취미",
            shopping: "쇼핑",
            beauty: "미용",
            gift: "경조사/선물",
            travel: "여행",
            etc: "기타",
            salary: "급여",
            additional: "부수입",
            allowance: "용돈",
          };

          category.textContent = categoryList[data.category];
          category.classList.add("transaction-category");
          memo.textContent = data.memo;
          memo.classList.add("transaction-memo");

          transactions.append(transactionDiv);
          div.append(category);
          div.append(memo);
          transactionDiv.append(div);
          transactionDiv.append(money);
        });
      }

      function handleCalendarClick(event) {
        const dates = [...document.querySelectorAll(".date")];
        dates.forEach((date) => date.classList.remove("selected-date"));
        event.target.classList.add("selected-date");
        currentDate = event.target.textContent;

        renderData();
      }

      // --- 달력 동적 생성 ---
      function renderCalendar() {
        const calendarDates = document.getElementById("calendarDates");
        const currentMonthElement = document.getElementById("currentMonth");
        const prevBtn = document.querySelector(".prev.btn");
        const nextBtn = document.querySelector(".next.btn");

        function renderDates() {
          const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
          const daysInMonth = new Date(
            currentYear,
            currentMonth + 1,
            0
          ).getDate();

          const startDayOfWeek = firstDayOfMonth.getDay();

          currentMonthElement.textContent = `${currentYear}년 ${
            currentMonth + 1
          }월`;

          calendarDates.innerHTML = "";

          for (let i = 0; i < startDayOfWeek; i++) {
            const emptyDate = document.createElement("div");
            emptyDate.classList.add("empty");
            calendarDates.appendChild(emptyDate);
          }

          for (let i = 1; i <= daysInMonth; i++) {
            const dateElement = document.createElement("div");
            dateElement.classList.add("date");
            dateElement.textContent = i;
            calendarDates.appendChild(dateElement);

            if (i === currentDate) {
              dateElement.classList.add("selected-date");
            }
          }
        }

        renderDates();

        prevBtn.addEventListener("click", () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          renderDates();
          updateDataAndEventListeners();
        });

        nextBtn.addEventListener("click", () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          renderDates();
          updateDataAndEventListeners();
        });
      }
      renderCalendar();

      function updateDataAndEventListeners() {
        renderData();

        const dates = [...document.querySelectorAll(".date")];

        dates.forEach((date) =>
          date.addEventListener("click", handleCalendarClick)
        );
      }
      updateDataAndEventListeners();
    </script>
  </body>
</html>
